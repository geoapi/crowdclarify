'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _tapdance = require('tapdance');

var _helpers = require('../helpers');

var _lib = require('../../lib');

var _lib2 = _interopRequireDefault(_lib);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var methods = _lib2['default'].methods;

var store = _lib2['default'].create();
var port = 2048;
var server = _lib2['default'].net.websocket(store, { port: port });

store.defineType('user', {
  name: { type: String }
});

(0, _tapdance.run)(function () {
  (0, _tapdance.comment)('websocket module');
  return store.connect().then(function () {
    return new _Promise(function (resolve) {
      var connection = new _ws2['default']('ws://localhost:' + port);

      connection.on('open', function () {
        store.request({
          method: methods.create,
          type: 'user',
          payload: [{
            id: 1,
            name: 'foobar'
          }]
        });
      });

      connection.on('message', function (data) {
        var json = JSON.parse(data);
        (0, _helpers.deepEqual)(json, { create: { user: [1] } }, 'data looks correct');
        server.close();
        store.disconnect();
        resolve();
      });
    });
  })['catch'](function (error) {
    return (0, _tapdance.fail)(error);
  });
});